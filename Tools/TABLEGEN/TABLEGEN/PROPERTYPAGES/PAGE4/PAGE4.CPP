#include "GRNMPCH.H"
#include "PAGE4.H"
#include "../../PROCESSING/PROCESSING.H"
//////////////////////////////////////////////////////////////////////////
using namespace HTL;
//////////////////////////////////////////////////////////////////////////
CPropertyPage4::CPropertyPage4(CString& filename, ATL::_U_STRINGorID title, bool IsExterior, bool EnableDoubleBuffer) :
	CResizablePropertyPageImpl<CPropertyPage4>(title, IsExterior, EnableDoubleBuffer),
	m_FileName(filename),
	m_TotalEntries(NULL),
	m_StartValue(NULL),
	m_EndValue(NULL),
	m_IncrementValue(NULL),
	m_TotalEntriesDW(NULL),
	m_StartValueDW(NULL),
	m_EndValueDW(NULL),
	m_IncrementValueDW(NULL)
{

}
//////////////////////////////////////////////////////////////////////////
CPropertyPage4::~CPropertyPage4(VOID)
{

}
//////////////////////////////////////////////////////////////////////////
BOOL CPropertyPage4::OnSetActive(VOID)
{

	//////////////////////////////////////////////////////////////////////////
	GetPropertySheet().SetWizardButtons(PSWIZB_FINISH | PSWIZB_BACK);
	//////////////////////////////////////////////////////////////////////////
	return TRUE;
	//////////////////////////////////////////////////////////////////////////

}
//////////////////////////////////////////////////////////////////////////
INT_PTR CPropertyPage4::OnWizardFinish(VOID)
{
	//////////////////////////////////////////////////////////////////////////
	//FINISH COMMAND														//
	//////////////////////////////////////////////////////////////////////////
	CString txt;
	DWORD txtlen;
	wchar_t *ptr;
	wchar_t *ptr_end;
	//////////////////////////////////////////////////////////////////////////
	m_TotalEntries.GetWindowText(txt);
	txtlen = txt.GetLength();
	ptr = txt.GetBuffer(txtlen);
	ptr_end = (ptr + txtlen);
	m_TotalEntriesDW = wcstol(ptr, &ptr_end, 10);
	txt.ReleaseBuffer();
	//////////////////////////////////////////////////////////////////////////
	m_StartValue.GetWindowText(txt);
	txtlen = txt.GetLength();
	ptr = txt.GetBuffer(txtlen);
	ptr_end = (ptr + txtlen);
	m_StartValueDW = wcstol(ptr, &ptr_end, 10);
	txt.ReleaseBuffer();
	//////////////////////////////////////////////////////////////////////////
	m_EndValue.GetWindowText(txt);
	txtlen = txt.GetLength();
	ptr = txt.GetBuffer(txtlen);
	ptr_end = (ptr + txtlen);
	m_EndValueDW = wcstol(ptr, &ptr_end, 10);
	txt.ReleaseBuffer();
	//////////////////////////////////////////////////////////////////////////
	m_IncrementValue.GetWindowText(txt);
	txtlen = txt.GetLength();
	ptr = txt.GetBuffer(txtlen);
	ptr_end = (ptr + txtlen);
	m_IncrementValueDW = wcstol(ptr, &ptr_end, 10);
	txt.ReleaseBuffer();
	//////////////////////////////////////////////////////////////////////////
	if (ProcLookupTable(m_FileName, m_TotalEntriesDW, m_StartValueDW, m_EndValueDW, m_IncrementValueDW) == FALSE) {
		MessageBox(L"ERROR IN LOOKUP TABLE GENERATION.", L"ERROR", MB_OK | MB_ICONERROR);
		return FALSE;
	}
	//////////////////////////////////////////////////////////////////////////
	return FALSE;
	//////////////////////////////////////////////////////////////////////////

}
//////////////////////////////////////////////////////////////////////////
LRESULT CPropertyPage4::OnInitDialog(HWND hWnd, LPARAM lParam)
{
	//////////////////////////////////////////////////////////////////////////
	CString LastValue;
	//////////////////////////////////////////////////////////////////////////
	m_TotalEntries.Detach();
	m_TotalEntries.Attach(GetDlgItem(IDC_EDIT_TOTAL_ENTRIES));
	LastValue = _AppSettings.GetUserProfileString(GRNM_LOOKUP_REGISTRY_SECTION, GRNM_LOOKUP_TOTAL_ENTRIES_REGISTRY_KEY, GRNM_LOOKUP_TOTAL_ENTRTIES_DEFAULT);
	m_TotalEntries.SetWindowText(LastValue);
	//////////////////////////////////////////////////////////////////////////
	m_StartValue.Detach();
	m_StartValue.Attach(GetDlgItem(IDC_EDIT_START_VALUE));
	LastValue = _AppSettings.GetUserProfileString(GRNM_LOOKUP_REGISTRY_SECTION, GRNM_LOOKUP_START_VALUE_REGISTRY_KEY, GRNM_LOOKUP_START_VALUE_DEFAULT);
	m_StartValue.SetWindowText(LastValue);
	//////////////////////////////////////////////////////////////////////////
	m_EndValue.Detach();
	m_EndValue.Attach(GetDlgItem(IDC_EDIT_END_VALUE));
	LastValue = _AppSettings.GetUserProfileString(GRNM_LOOKUP_REGISTRY_SECTION, GRNM_LOOKUP_END_VALUE_REGISTRY_KEY, GRNM_LOOKUP_END_VALUE_DEFAULT);
	m_EndValue.SetWindowText(LastValue);
	//////////////////////////////////////////////////////////////////////////
	m_IncrementValue.Detach();
	m_IncrementValue.Attach(GetDlgItem(IDC_EDIT_INCREMENT));
	LastValue = _AppSettings.GetUserProfileString(GRNM_LOOKUP_REGISTRY_SECTION, GRNM_LOOKUP_INCREMENT_VALUE_REGISTRY_KEY, GRNM_LOOKUP_INCREMENT_VALUE_DEFAULT);
	m_IncrementValue.SetWindowText(LastValue);
	//////////////////////////////////////////////////////////////////////////
	SetMsgHandled(FALSE);
	//////////////////////////////////////////////////////////////////////////
	return TRUE;
	//////////////////////////////////////////////////////////////////////////

}
//////////////////////////////////////////////////////////////////////////
BOOL CPropertyPage4::OnQueryCancel(VOID)
{

	//////////////////////////////////////////////////////////////////////////
	return FALSE;
	//////////////////////////////////////////////////////////////////////////

}
//////////////////////////////////////////////////////////////////////////
LRESULT CPropertyPage4::OnEnChangeEditTotalEntries(WORD /*wNotifyCode*/, WORD /*wID*/, HWND /*hWndCtl*/, BOOL& bHandled)
{
	//////////////////////////////////////////////////////////////////////////
	bHandled = TRUE;
	//////////////////////////////////////////////////////////////////////////
	CString LastValue;
	m_TotalEntries.GetWindowText(LastValue);
	//////////////////////////////////////////////////////////////////////////
	_AppSettings.WriteUserProfileString(GRNM_LOOKUP_REGISTRY_SECTION, GRNM_LOOKUP_TOTAL_ENTRIES_REGISTRY_KEY, LastValue);
	//////////////////////////////////////////////////////////////////////////
	return 0;
	//////////////////////////////////////////////////////////////////////////

}
//////////////////////////////////////////////////////////////////////////
LRESULT CPropertyPage4::OnEnChangeEditStartValue(WORD /*wNotifyCode*/, WORD /*wID*/, HWND /*hWndCtl*/, BOOL& bHandled)
{
	//////////////////////////////////////////////////////////////////////////
	bHandled = TRUE;
	//////////////////////////////////////////////////////////////////////////
	CString LastValue;
	m_StartValue.GetWindowText(LastValue);
	//////////////////////////////////////////////////////////////////////////
	_AppSettings.WriteUserProfileString(GRNM_LOOKUP_REGISTRY_SECTION, GRNM_LOOKUP_START_VALUE_REGISTRY_KEY, LastValue);
	//////////////////////////////////////////////////////////////////////////
	return 0;
	//////////////////////////////////////////////////////////////////////////

}
//////////////////////////////////////////////////////////////////////////
LRESULT CPropertyPage4::OnEnChangeEditEndValue(WORD /*wNotifyCode*/, WORD /*wID*/, HWND /*hWndCtl*/, BOOL& bHandled)
{
	//////////////////////////////////////////////////////////////////////////
	bHandled = TRUE;
	//////////////////////////////////////////////////////////////////////////
	CString LastValue;
	m_EndValue.GetWindowText(LastValue);
	//////////////////////////////////////////////////////////////////////////
	_AppSettings.WriteUserProfileString(GRNM_LOOKUP_REGISTRY_SECTION, GRNM_LOOKUP_END_VALUE_REGISTRY_KEY, LastValue);
	//////////////////////////////////////////////////////////////////////////
	return 0;
	//////////////////////////////////////////////////////////////////////////

}
//////////////////////////////////////////////////////////////////////////
LRESULT CPropertyPage4::OnEnChangeEditIncrement(WORD /*wNotifyCode*/, WORD /*wID*/, HWND /*hWndCtl*/, BOOL& bHandled)
{
	//////////////////////////////////////////////////////////////////////////
	bHandled = TRUE;
	//////////////////////////////////////////////////////////////////////////
	CString LastValue;
	m_IncrementValue.GetWindowText(LastValue);
	//////////////////////////////////////////////////////////////////////////
	_AppSettings.WriteUserProfileString(GRNM_LOOKUP_REGISTRY_SECTION, GRNM_LOOKUP_INCREMENT_VALUE_REGISTRY_KEY, LastValue);
	//////////////////////////////////////////////////////////////////////////
	return 0;
	//////////////////////////////////////////////////////////////////////////

}
