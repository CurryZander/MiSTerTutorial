#include "GRNMPCH.H"
#include "LOADLISTDIALOG.H"
//////////////////////////////////////////////////////////////////////////
CLoadListDialogsHandler::CLoadListDialogsHandler(VOID){

}
//////////////////////////////////////////////////////////////////////////
CLoadListDialogsHandler::~CLoadListDialogsHandler(VOID){

}
//////////////////////////////////////////////////////////////////////////
STDMETHODIMP CLoadListDialogsHandler::OnFileOk(IFileDialog* pfd){
	return S_OK;    // allow the dialog to close
}
//////////////////////////////////////////////////////////////////////////
STDMETHODIMP CLoadListDialogsHandler::OnFolderChanging(IFileDialog* pfd,IShellItem* psiFolder){
	return S_OK;    // allow the change
}
//////////////////////////////////////////////////////////////////////////
STDMETHODIMP CLoadListDialogsHandler::OnFolderChange(IFileDialog* pfd){
	return S_OK;
}
//////////////////////////////////////////////////////////////////////////
STDMETHODIMP CLoadListDialogsHandler::OnSelectionChange(IFileDialog* pfd){
	return S_OK;
}
//////////////////////////////////////////////////////////////////////////
STDMETHODIMP CLoadListDialogsHandler::OnShareViolation(IFileDialog* pfd,IShellItem* psi,FDE_SHAREVIOLATION_RESPONSE* pResponse){
	return S_OK;
}
//////////////////////////////////////////////////////////////////////////
STDMETHODIMP CLoadListDialogsHandler::OnTypeChange(IFileDialog* pfd){
	return S_OK;
}
//////////////////////////////////////////////////////////////////////////
STDMETHODIMP CLoadListDialogsHandler::OnOverwrite(IFileDialog* pfd,IShellItem* psi,FDE_OVERWRITE_RESPONSE* pResponse){
	return S_OK;
}
//////////////////////////////////////////////////////////////////////////
// IFileDialogControlEvents methods
//////////////////////////////////////////////////////////////////////////
STDMETHODIMP CLoadListDialogsHandler::OnItemSelected(IFileDialogCustomize* pfdc,DWORD dwIDCtl,DWORD dwIDItem){
	return S_OK;
}
//////////////////////////////////////////////////////////////////////////
STDMETHODIMP CLoadListDialogsHandler::OnButtonClicked(IFileDialogCustomize* pfdc,DWORD dwIDCtl){
	return S_OK;
}
//////////////////////////////////////////////////////////////////////////
STDMETHODIMP CLoadListDialogsHandler::OnCheckButtonToggled(IFileDialogCustomize* pfdc,DWORD dwIDCtl,BOOL bChecked){
	return S_OK;
}
//////////////////////////////////////////////////////////////////////////
STDMETHODIMP CLoadListDialogsHandler::OnControlActivating(IFileDialogCustomize* pfdc,DWORD dwIDCtl){
	return S_OK;
}
//////////////////////////////////////////////////////////////////////////
BOOL LoadFileListWithIFileOpenDlgEx(CString& filenamepath){

	//////////////////////////////////////////////////////////////////////////
	HRESULT hr;
	CComPtr<IFileOpenDialog> pDlg;
	//////////////////////////////////////////////////////////////////////////
	vector<CString> vecsFilterParts;
	vector<COMDLG_FILTERSPEC> vecFilters;
	//////////////////////////////////////////////////////////////////////////
	DWORD dwFlags=0;
	//////////////////////////////////////////////////////////////////////////
	CString strTitle;
	CString strOKButton;
	CString strDefaultExtention;
	CString strFileNameLable;
	//////////////////////////////////////////////////////////////////////////
	strTitle.LoadString(IDS_LOAD_LIST_FILE);
	strOKButton.LoadString(IDS_LOAD_LIST_FILE_OK_BUTTON);
	strDefaultExtention.LoadString(IDS_LOAD_LIST_FILE_DEFAULT);
	strFileNameLable.LoadString(IDS_LOAD_LIST_FILE_FILENAME_LABLE);
	//////////////////////////////////////////////////////////////////////////
	hr=pDlg.CoCreateInstance(__uuidof(FileOpenDialog));
	//////////////////////////////////////////////////////////////////////////
	if(FAILED(hr)){
		return FALSE;
	}
	//////////////////////////////////////////////////////////////////////////
	static const GUID guidFileSave=LOADFILE_LIST_FILE_GUID;
	hr=pDlg->SetClientGuid(guidFileSave);
	//////////////////////////////////////////////////////////////////////////
	if(BuildFilterSpecList(IDS_LIST_FILE_FILTERS,vecsFilterParts,vecFilters)){
		hr=pDlg->SetFileTypes((UINT)vecFilters.size(),&vecFilters[0]);
	}
	//////////////////////////////////////////////////////////////////////////
	pDlg->SetTitle(strTitle);
	pDlg->SetOkButtonLabel(strOKButton);
	pDlg->SetDefaultExtension(strDefaultExtention);
	pDlg->SetFileNameLabel(strFileNameLable);
	hr=pDlg->SetFileName(filenamepath);
// 	hr=pDlg->GetOptions(&dwFlags);
	hr=pDlg->SetOptions(/*dwFlags|*//*FOS_OVERWRITEPROMPT|FOS_CREATEPROMPT|*/FOS_SHAREAWARE|/*FOS_NOREADONLYRETURN|*/FOS_FORCEPREVIEWPANEON|FOS_PATHMUSTEXIST|FOS_FORCEFILESYSTEM);
	//////////////////////////////////////////////////////////////////////////
	// Set up our event listener.											//
	//////////////////////////////////////////////////////////////////////////
	CComObjectStackEx<CLoadListDialogsHandler> cbk;
	CComQIPtr<IFileDialogEvents> pEvents=cbk.GetUnknown();
	DWORD dwCookie;
	bool bAdvised;
	//////////////////////////////////////////////////////////////////////////
	hr=pDlg->Advise(pEvents,&dwCookie);
	bAdvised=SUCCEEDED(hr);
	//////////////////////////////////////////////////////////////////////////
	// Set an IFileDialogCustomize interface.								//
	//////////////////////////////////////////////////////////////////////////
	CComQIPtr<IFileDialogCustomize> pfdc=pDlg;
	//////////////////////////////////////////////////////////////////////////
	if(pfdc){

	}
	//////////////////////////////////////////////////////////////////////////
	hr=pDlg->Show(NULL);
	//////////////////////////////////////////////////////////////////////////
	if(bAdvised){
		pDlg->Unadvise(dwCookie);
	}
	//////////////////////////////////////////////////////////////////////////
	if(SUCCEEDED(hr)){
		//////////////////////////////////////////////////////////////////////////
		CComPtr<IShellItem> pItem;
		hr=pDlg->GetResult(&pItem);
		//////////////////////////////////////////////////////////////////////////
		if(SUCCEEDED(hr)){
			CString sPath;
			if(PathFromShellItem(pItem,sPath)){
				filenamepath=sPath;
			}
		}
		//////////////////////////////////////////////////////////////////////////
		return TRUE;
		//////////////////////////////////////////////////////////////////////////
	}
	//////////////////////////////////////////////////////////////////////////
	return FALSE;
	//////////////////////////////////////////////////////////////////////////

}
//////////////////////////////////////////////////////////////////////////








